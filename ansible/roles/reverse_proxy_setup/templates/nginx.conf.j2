user nginx;     # 프로세스 실행 권한 사용자
worker_processes auto; 
error_log /var/log/nginx/error.log;  # 에러 로그 파일 위치
pid /run/nginx.pid;     

# stream 모듈 로드 
load_module /usr/lib64/nginx/modules/ngx_stream_module.so;

# mod_security 모듈 로드
load_module /usr/lib64/nginx/modules/ngx_http_modsecurity_module.so;

events {
    worker_connections 1024;   # 동시 접속 가능한 최대 클라이언트 수
}

### TCP Reverse Proxy 설정 ###
stream {

    # Control Plane 로드밸런싱 및 수동 Health Check 설정
    upstream control {
        least_conn;  # 현재 연결 수가 적은 서버로 트래픽 전달(기본값: 라운드로빈)
        server {{ url.control_plane[0]}}:6443  max_fails=3 fail_timeout=30s;  # 30초 동안 3번 이상 응답 실패 시 30초 동안 비활성화
        server {{ url.control_plane[1]}}:6443  max_fails=3 fail_timeout=30s;
        server {{ url.control_plane[2]}}:6443  max_fails=3 fail_timeout=30s;
    }

    server {
        listen 6443;               # 6443번 포트 + TCP 통신
        proxy_pass control;        # 트래픽을 전달할 Control Plane 서버
    }
}

### HTTP/HTTPS Reverse Proxy 설정 ###
http {
    include /etc/nginx/mime.types; 
    default_type application/octet-stream;  

    # MinIO API 로드밸런싱 및 수동 Health Check 설정
    upstream minio {
        ip_hash;   # 동일한 클라이언트의 요청을 동일 서버로 전달
        server {{ url.minio[0]}}:9000   max_fails=3 fail_timeout=30s;   # 30초 동안 3번 이상 응답 실패 시 30초 동안 비활성화
        server {{ url.minio[1]}}:9000   max_fails=3 fail_timeout=30s;
    }

    # MinIO 콘솔 로드밸런싱 및 수동 Health Check 설정
    upstream minio_console {
        ip_hash;
        server {{ url.minio[0]}}:9001   max_fails=3 fail_timeout=30s;   # 30초 동안 3번 이상 응답 실패 시 30초 동안 비활성화
        server {{ url.minio[1]}}:9001   max_fails=3 fail_timeout=30s;
    }
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"'; 

    access_log /var/log/nginx/access.log main;  

    sendfile on;               # 파일 전송 최적화
    tcp_nopush on;             # 큰 파일 전송 시 데이터를 모아 효율적으로 전송
    tcp_nodelay on;            # TCP Nagle 알고리즘 비활성화
    keepalive_timeout 65;      # 연결 유지 시간
    types_hash_max_size 2048;  # MIME 타입 해시 크기

    # 캐시 경로 및 정책 설정
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=nginx_cache:100m inactive=30d max_size=10g;

    # HTTP 요청을 HTTPS로 강제 리디렉션
    server {
        listen 80;  
        server_name {{ external_domain | join(' ') }};
        return 301 https://$host$request_uri;   # 80 포트로 들어오면 443으로 리디렉트
    }  

    server {
        listen 443 ssl;   # 443 포트 + HTTPS 통신
        server_name {{ external_domain | join(' ') }};
        
        # WAF 활성화
        modsecurity on;
        modsecurity_rules_file  /etc/nginx/modsec/main.conf;

        # SSL/TLS 설정
        ssl_certificate         /etc/ssl/certs/my_server.crt;
        ssl_certificate_key     /etc/ssl/private/my_server.key; 
        
        # Web Application
        location / {
            proxy_pass http://{{ url.web }}/;           # metalLB 서버 주소
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jenkins
        location /jenkins/github-webhook/ {
            proxy_pass http://{{ url.jenkins }}:8080/jenkins/github-webhook/;  # Jenkins 서버 주소 
        }

        location /api/ {
            proxy_pass http://{{ api_backend }}:{{ api_port }};
            
            # 응답 데이터 내의 내부 IP 주소를 외부 도메인/IP로 치환
            sub_filter 'http://10.5.1.20:9000' 'https://alwaysonteam.store';
            sub_filter 'http://10.5.1.20:9000' 'https://www.alwaysonteam.store';
            sub_filter_once off;        # 모든 문자열에 대해 치환 적용
            sub_filter_types application/json; # JSON 데이터 타입에도 적용
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # 압축된 응답은 치환이 안 될 수 있으므로 압축 해제 헤더 추가
            proxy_set_header Accept-Encoding ""; 
        }

        # Video Thumb Cache (MinIO 서버 대상 이미지 캐싱)
        location /video-thumb/ {
            proxy_pass http://minio;  # 상단 upstream minio 사용
            proxy_cache nginx_cache;                # 캐시 영역 지정
            proxy_cache_valid 200 301 302 10d;      # 요청이 성공하면 응답을 10일 동안 캐싱
            proxy_cache_lock on;                    # 동시 요청 시 하나만 원본 서버로 전달
            proxy_cache_use_stale error timeout updating; # 서버 문제 시 캐시 응답
            expires 10d;                            # 브라우저 캐싱
            add_header X-Cache-Status $upstream_cache_status;

            proxy_set_header Host {{ internal_domain }}:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Video HLS Cache (MinIO 서버 대상 영상 캐싱)
        location /video-hls/ {
            proxy_pass http://minio;  # 상단 upstream minio 사용
            proxy_cache nginx_cache;                # 캐시 영역 지정
            proxy_cache_valid 200 301 302 1h;       # 요청이 성공하면 응답을 1시간 동안 캐싱
            proxy_cache_lock on;                    # 동시 요청 시 하나만 원본 서버로 전달
            proxy_cache_use_stale error timeout updating; # 원본 서버 문제 시 캐시 응답
            expires 1h;                             # 브라우저 캐싱
            add_header X-Cache-Status $upstream_cache_status;

            proxy_set_header Host {{ internal_domain }}:9000;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    
    # MinIO API
    server {
        listen 9000;   # 9000번 포트 + HTTP 통신
        server_name {{ internal_domain }};

        client_max_body_size 0;  # 업로드 용량 제한 없음

        # 버퍼링 비활성화
        proxy_buffering off;
        proxy_request_buffering off;

        location / {
            proxy_pass http://minio;   # MinIO 서버 주소 
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # MinIO Consol
    server {
        listen 9001;   # 9001번 포트 + HTTP 통신
        server_name {{ internal_domain }};

        location / {
            proxy_pass http://minio_console;   # MinIO 서버 주소 
         
            # 웹 소켓 지원
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Origin http://$host;

            add_header X-Server $upstream_addr;   # 실제 요청을 처리한 서버의 IP 주소와 포트 정보를 응답 헤더에 추가 
        }
    }
}